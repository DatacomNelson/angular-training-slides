<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="search-domain" content="http://rangle.io" />
    <link href="http://localhost:4000/css/bootstrap.css" rel="stylesheet" />
    <link href="http://localhost:4000/css/bootstrap-theme.css" rel="stylesheet" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Services</title>
  </head>
  <body>
    <div class="container shadow">
      <div class="row-fluid">
        <div class="span10 offset1">
          <p><a href="http://rangle.io">Rangle.io</a> Angular Training</a></p>
          <h1>Services</h1>
          <hr />
<!-- .slide: id="services-roadmap" -->
<h2 id="roadmap">Roadmap</h2>

<ol>
  <li>What is a service?</li>
  <li>How do we create services?</li>
  <li>How do we use services?</li>
  <li>Why do we use services?</li>
</ol>

<hr />
<!-- .slide: id="services-what-is-a-service" -->
<h2 id="what-is-a-service">What is a Service?</h2>

<ul>
  <li>Something that provides functionality to many components
    <ul>
      <li>Frequently implemented as a singleton</li>
      <li>Database connection, HTTP, etc.</li>
    </ul>
  </li>
  <li>Does not produce a view itself</li>
</ul>

<hr />
<!-- .slide: id="services-creating-a-service" -->
<h2 id="creating-a-service">Creating a Service</h2>

<ul>
  <li>Use <code class="highlighter-rouge">ng generate service toDo</code></li>
  <li>Creates <code class="highlighter-rouge">src/app/to-do.service.*</code>
    <ul>
      <li>Note: in the <code class="highlighter-rouge">src/app</code> directory</li>
      <li>We could (and should) create a <code class="highlighter-rouge">services</code> directory</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>├── src
│   ├── app
│   │   ├── to-do.service.spec.ts
│   │   └── to-do.service.ts
</code></pre>
</div>

<hr />
<!-- .slide: id="services-whats-in-a-service" -->
<h2 id="whats-in-a-service">What’s in a Service?</h2>

<ul>
  <li>A service is just a class decorated with <code class="highlighter-rouge">@Injectable</code></li>
</ul>

<p><em>src/app/to-do.service.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">ToDoService</span> <span class="p">{</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="services-registering-a-service-1" -->
<h2 id="registering-a-service">Registering a Service</h2>

<ul>
  <li>Services need to be registered before they can be used
    <ul>
      <li>Angular CLI does this automatically for new components</li>
    </ul>
  </li>
  <li>Must add the class name to the <code class="highlighter-rouge">providers</code> field in <code class="highlighter-rouge">src/app/app.module.ts</code></li>
</ul>

<p>Notes:</p>
<ul>
  <li>Which means importing the class name from <code class="highlighter-rouge">./to-do.service</code>
    <ul>
      <li>Note: must have <code class="highlighter-rouge">./</code> at the start of the path</li>
      <li>And must <em>not</em> include the <code class="highlighter-rouge">.ts</code> suffix</li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="services-registering-a-service-2" -->
<h2 id="registering-a-service-1">Registering a Service</h2>

<p><em>src/app/app.module.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="c1">// ...other imports generated by Angular CLI...</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ToDoService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./to-do.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">NgModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">AppComponent</span><span class="p">,</span>
    <span class="nx">ToDoListComponent</span><span class="p">,</span>
    <span class="nx">GenericInputComponent</span>
  <span class="p">],</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">BrowserModule</span><span class="p">,</span>
    <span class="nx">FormsModule</span><span class="p">,</span>
    <span class="nx">HttpModule</span>
  <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">ToDoService</span>     <span class="c1">// added</span>
  <span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="services-getting-access-to-a-service" -->
<h2 id="getting-access-to-a-service">Getting Access to a Service</h2>

<ul>
  <li>Add a variable to the constructor with the type of the service</li>
  <li>Angular’s <em>dependency injection</em> system will give the component access to an instance of that class
    <ul>
      <li>Angular’s default behavior for dependencies is a singleton</li>
      <li><code class="highlighter-rouge">private</code> means that <code class="highlighter-rouge">toDoService</code> as a class property of <code class="highlighter-rouge">ToDoListComponent</code> can only be accessed within the component itself</li>
    </ul>
  </li>
</ul>

<p><em>src/app/to-do-list/to-do-list.component.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">ToDoService</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'../to-do.service'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="c1">// ...as before...</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">ToDoListComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="err">@</span><span class="nx">Input</span><span class="p">()</span> <span class="nx">thingsToDo</span><span class="err">:</span> <span class="kr">string</span><span class="p">[];</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">toDoService</span><span class="err">:</span> <span class="nx">ToDoService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="services-a-plan-for-refactoring" -->
<h2 id="a-plan-for-refactoring">A Plan for Refactoring</h2>

<ol>
  <li><code class="highlighter-rouge">GenericInputComponent</code> gets a new item and sends it to <code class="highlighter-rouge">AppComponent</code>
    <ul>
      <li>No change required</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">AppComponent</code> gives it to <code class="highlighter-rouge">ToDoService</code>
    <ul>
      <li>Inject <code class="highlighter-rouge">ToDoService</code> into <code class="highlighter-rouge">AppComponent</code></li>
      <li>Remove <code class="highlighter-rouge">thingsToDo</code> from <code class="highlighter-rouge">AppComponent</code>, since it is no longer storing state</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">ToDoService</code> stores the current list of items</li>
  <li><code class="highlighter-rouge">ToDoListComponent</code> watches the service for new lists of items
    <ul>
      <li>Send it the entire new list rather than just updates</li>
    </ul>
  </li>
</ol>

<p>FIXME: data flow diagram</p>

<hr />
<!-- .slide: id="services-fill-in-the-service" -->
<h2 id="fill-in-the-service">Fill In the Service</h2>

<p><em>src/app/to-do.service.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BehaviorSubject</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'rxjs/BehaviorSubject'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">ToDoService</span> <span class="p">{</span>

  <span class="nl">changes</span><span class="p">:</span> <span class="nx">BehaviorSubject</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">[]</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="p">([]);</span>
  <span class="nl">items</span><span class="p">:</span> <span class="kr">string</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">getChanges</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">changes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">addItem</span><span class="p">(</span><span class="nx">item</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="services-what-is-a-behaviorsubject" -->
<h2 id="interlude-whats-a-behavior-subject">Interlude: What’s a Behavior Subject?</h2>

<ul>
  <li>Modern JavaScript relies heavily on the <em>observer/observable</em> pattern
    <ul>
      <li>The observable notifies observers when things change</li>
      <li>The observer takes action whenever the things they’re observing change</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">BehaviorSubject</code> is an observable with an initial state</li>
  <li>Again, specify type of values using generics
    <ul>
      <li><code class="highlighter-rouge">changes</code> will repeatedly serve a list of strings</li>
    </ul>
  </li>
  <li>But <code class="highlighter-rouge">BehaviorSubject</code> doesn’t actually store state</li>
  <li>So use a plain old list of strings called <code class="highlighter-rouge">items</code> to do that</li>
</ul>

<hr />
<!-- .slide: id="services-refactor-the-display" -->
<h2 id="refactor-the-display">Refactor the Display</h2>

<p><em>src/app/to-do-list/to-do-list.component.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="kr">class</span> <span class="nx">ToDoListComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>

  <span class="err">@</span><span class="nx">Input</span><span class="p">()</span> <span class="nx">thingsToDo</span><span class="err">:</span> <span class="kr">string</span><span class="p">[];</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">toDoService</span><span class="err">:</span> <span class="nx">ToDoService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toDoService</span><span class="p">.</span><span class="nx">getChanges</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">newItems</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">thingsToDo</span> <span class="o">=</span> <span class="nx">newItems</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>Use <code class="highlighter-rouge">Array.slice</code> to copy the list of changes each time it arrives
    <ul>
      <li>Otherwise this component would be sharing state with the service</li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="services-interlude-object-lifecycles" -->
<h2 id="interlude-object-lifecycles">Interlude: Object Lifecycles</h2>

<ul>
  <li>Q: why set up the subscription in <code class="highlighter-rouge">ngOnInit</code>?</li>
  <li>A: because we don’t control the order in which objects are initialized</li>
  <li>Angular calls <code class="highlighter-rouge">ngOnInit</code> after everything has been constructed
but before anything is used</li>
  <li>See Angular’s <a href="https://angular.io/docs/ts/latest/guide/lifecycle-hooks.html">Lifecycle Hooks</a> documentation for details</li>
</ul>

<p><img src="images/hooks-in-sequence-resized.png" alt="Angular Object Lifecycle" /></p>

<hr />
<!-- .slide: id="services-refactor-the-app" -->
<h2 id="refactor-the-app">Refactor the App</h2>

<p><em>src/app/app.component.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="kr">class</span> <span class="nx">AppComponent</span> <span class="p">{</span>

  <span class="nx">title</span> <span class="o">=</span> <span class="s1">'To Do'</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">toDoService</span><span class="err">:</span> <span class="nx">ToDoService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">onNewItem</span><span class="p">(</span><span class="nx">item</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toDoService</span><span class="p">.</span><span class="nx">addItem</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="services-what-reactive-really-means" -->
<h2 id="what-reactive-really-means">What Reactive Really Means</h2>

<ul>
  <li>This is a lot of work for an application this size</li>
  <li>But absolutely necessary in larger applications</li>
  <li>Main application no longer needs to know who’s doing what with the to-do list</li>
  <li>Could add a counter showing number of things to do by:
    <ol>
      <li>Creating a new component</li>
      <li>Injecting the <code class="highlighter-rouge">ToDoService</code> into it</li>
      <li>Having its HTML display the count</li>
      <li>Including its tag in the main page</li>
    </ol>
  </li>
  <li>More importantly, components are now testable in isolation
    <ul>
      <li>Inject something else into <code class="highlighter-rouge">ToDoListComponent</code> to test its behavior</li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="services-quiz-1" -->
<!-- .slide: data-background="images/question-slide.jpg" -->

<h2 id="quiz">Quiz</h2>

<p>What is the correct way to inject a service into a class?</p>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="mi">1</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="kd">constructor</span><span class="p">(</span><span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Http</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

<span class="mi">2</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">;</span>
    <span class="p">}</span>

<span class="mi">3</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="kd">constructor</span><span class="p">(</span><span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">}</span>

<span class="mi">4</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Http</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>+++
<!-- .slide: data-background="images/answer-slide.jpg" --></p>

<h2 id="answer">Answer</h2>

<p>Correct answer is 3.</p>

<p>4: While it is possible to instantiate classes manually, (and in some
simple, stateless services you may actually get the behavior you’re
expecting), manually instantiated classes lose the benefit of
Angular’s DI (their dependencies are no longer able to be dependency
injected) and they require you to manually construct and manage a
dependency tree yourself. Additionally, you’re overriding the default
singleton nature of providers in Angular which may lead to unexpected
behavior.</p>

<p>1: Similar to 4 above with the caveat that <code class="highlighter-rouge">Http</code> will not be passed
into the constructor to begin with. Providers may only be injected via
a typed constructor parameter (or <code class="highlighter-rouge">@Inject</code> token).</p>

<p>2: It’s possible that when students learn that dependencies are
injected into a class constructor based on its type, they may expect
this type reflection to also apply to class members.</p>

<hr />
<!-- .slide: data-background="images/question-slide.jpg" -->
<!-- .slide: id="services-quiz-2" -->
<h2 id="quiz-1">Quiz</h2>

<p>Which of the below snippets would <em>not</em> assign a service instance to a
class member (make it available on <code class="highlighter-rouge">this</code>)?</p>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="mi">1</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="kd">constructor</span><span class="p">(</span><span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">}</span>

<span class="mi">2</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">}</span>

<span class="mi">3</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span>
    <span class="p">}</span>

<span class="mi">4</span><span class="p">.</span>  <span class="kr">class</span> <span class="nx">MyComponent</span> <span class="p">{</span>
      <span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">;</span>
      <span class="kd">constructor</span><span class="p">(</span><span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">http</span> <span class="o">=</span> <span class="nx">http</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>+++
<!-- .slide: data-background="images/answer-slide.jpg" --></p>

<h2 id="answer-1">Answer</h2>

<p>Correct answer is 1.</p>

<p>1: While an instantiated <code class="highlighter-rouge">Http</code> service will be available in the
constructor, it has not actually been assigned to the class instance
and so is now only available inside of the constructor.</p>

<p>2, 3: The <code class="highlighter-rouge">private</code> and <code class="highlighter-rouge">public</code> keywords in typescript will
implicitly assign constructor arguments to the class instance.</p>

<p>4: If you do not specify <code class="highlighter-rouge">private</code> or <code class="highlighter-rouge">public</code>, you are still able to
manually assign a provider instance to a class property.</p>

<hr />
<!-- .slide: data-background="images/question-slide.jpg" -->
<!-- .slide: id="services-quiz-3" -->
<h2 id="quiz-2">Quiz</h2>

<p>Injecting a service into a class accomplishes which of the following?</p>

<ol>
  <li>
    <p>A new instance of the service is constructed which is then made
available to the class.</p>
  </li>
  <li>
    <p>A new instance of the service is constructed only if it has not
been injected before, otherwise an existing instance is reused. The
instance of the service is then made available to the class.</p>
  </li>
  <li>
    <p>An existing instance of the service is made available to the class
only if it has already been registered in the <code class="highlighter-rouge">providers</code> array.</p>
  </li>
</ol>

<p>+++
<!-- .slide: data-background="images/answer-slide.jpg" --></p>

<h2 id="answer-2">Answer</h2>

<p>Correct answer is 3.</p>

<p>1, 2: Services can only be injected once they’ve been explicitly
registered inside of a <code class="highlighter-rouge">providers</code> array. Angular’s DI does not
implicitly construct classes on request.</p>

<hr />
<!-- .slide: data-background="images/question-slide.jpg" -->
<!-- .slide: id="services-quiz-4" -->
<h2 id="quiz-3">Quiz</h2>

<p>When generating a service called <code class="highlighter-rouge">MyService</code> using Angular CLI, what
must be done manually before the service can be used?</p>

<ol>
  <li>
    <p>Import the <code class="highlighter-rouge">MyServiceModule</code> into the <code class="highlighter-rouge">AppModule</code></p>
  </li>
  <li>
    <p>Add <code class="highlighter-rouge">MyService</code> into the <code class="highlighter-rouge">providers</code> array</p>
  </li>
  <li>
    <p>Import the <code class="highlighter-rouge">MyServiceModule</code> into the <code class="highlighter-rouge">AppModule</code> and add
<code class="highlighter-rouge">MyService</code> into the <code class="highlighter-rouge">providers</code> array</p>
  </li>
</ol>

<p>+++
<!-- .slide: data-background="images/answer-slide.jpg" --></p>

<h2 id="answer-3">Answer</h2>

<p>Correct answer is 2.</p>

<p>1, 3: Angular CLI will only generate a service and service test file,
no corresponding module is created. This may be confused in the case
where we’re required to import the <code class="highlighter-rouge">HttpModule</code> in order to use it.</p>

          <hr/>
          <a href="http://localhost:4000/">Home</a>
        </div>
      </div>
    </div>
  </body>
</html>
