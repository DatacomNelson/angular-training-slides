<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="search-domain" content="http://rangle.io" />
    <link href="http://localhost:4000/css/bootstrap.css" rel="stylesheet" />
    <link href="http://localhost:4000/css/bootstrap-theme.css" rel="stylesheet" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>The HTTP Service</title>
  </head>
  <body>
    <div class="container shadow">
      <div class="row-fluid">
        <div class="span10 offset1">
          <p><a href="http://rangle.io">Rangle.io</a> Angular Training</a></p>
          <h1>The HTTP Service</h1>
          <hr />
<!-- .slide: id="http-roadmap" -->
<h2 id="roadmap">Roadmap</h2>

<ol>
  <li>How does Angular interact with HTTP?</li>
  <li>How can I get data from a server?</li>
  <li>How can I send data to a server?</li>
</ol>

<hr />
<!-- .slide: id="http-http-service" -->
<h2 id="the-built-in-http-service">The Built-in <code class="highlighter-rouge">Http</code> Service</h2>

<ul>
  <li>Service provided by Angular to perform REST operations</li>
  <li>Has a method for each HTTP verb: <code class="highlighter-rouge">get</code>, <code class="highlighter-rouge">post</code>, <code class="highlighter-rouge">put</code>, <code class="highlighter-rouge">delete</code></li>
  <li>Each method returns an <code class="highlighter-rouge">Observable</code> that emits a single value</li>
  <li>Connections are closed automatically after the value is emitted</li>
</ul>

<hr />
<!-- .slide: id="http-importing" -->
<h2 id="importing-the-service">Importing the Service</h2>

<ul>
  <li>Angular CLI automatically imports <code class="highlighter-rouge">HttpModule</code> in <code class="highlighter-rouge">app.module.ts</code></li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">HttpModule</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">NgModule</span><span class="p">({</span>
  <span class="p">...</span><span class="nx">other</span> <span class="nx">content</span><span class="p">...</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">...</span><span class="nx">other</span> <span class="nx">imports</span><span class="p">...</span>
    <span class="nx">HttpModule</span>
  <span class="p">],</span>
  <span class="p">...</span><span class="nx">other</span> <span class="nx">content</span><span class="p">...</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{}</span>
</code></pre>
</div>

<!-- preview: https://plnkr.co/edit/l4n2upSueYw5UbFjZB1C?p=preview -->

<hr />
<!-- .slide: id="http-json-server" -->
<h2 id="interlude-setting-up-a-json-data-server">Interlude: Setting Up a JSON Data Server</h2>

<ul>
  <li>Use <a href="https://github.com/typicode/json-server">JSON Server</a> to set up a little JSON store</li>
  <li><code class="highlighter-rouge">npm install json-server --save</code></li>
  <li>Create the file shown below in <code class="highlighter-rouge">src/db.json</code></li>
  <li><code class="highlighter-rouge">./node_modules/.bin/json-server --watch src/db.json</code></li>
  <li>Go to <a href="http://localhost:3000/items">http://localhost:3000/items</a> to test</li>
</ul>

<p><em>src/db.json</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"items"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"todo"</span><span class="err">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"Learn JavaScript"</span><span class="p">},</span>
      <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"Learn Node"</span><span class="p">},</span>
      <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">:</span> <span class="s2">"Learn Angular"</span><span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="http-using-on-startup" -->
<h2 id="using-the-http-service-on-startup">Using the HTTP Service on Startup</h2>

<ul>
  <li>Modify <code class="highlighter-rouge">AppComponent</code> to ask <code class="highlighter-rouge">toDoService</code> to initialize itself</li>
</ul>

<p><em>src/app/app.component.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="c1">// ...as before...</span>

<span class="k">export</span> <span class="kr">class</span> <span class="nx">AppComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="c1">// ...as before...</span>
  <span class="kd">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="nx">toDoService</span><span class="err">:</span> <span class="nx">ToDoService</span>
  <span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toDoService</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>Get a compiler error (since <code class="highlighter-rouge">toDoService.initialize</code> isn’t defined yet)</li>
</ul>

<hr />
<!-- .slide: id="http-fetching-data-1" -->
<h2 id="fetch-data-from-the-server">Fetch Data From the Server</h2>

<p><em>src/app/to-do.service.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">export</span> <span class="kr">class</span> <span class="nx">ToDoService</span> <span class="p">{</span>

  <span class="nl">baseUrl</span><span class="p">:</span> <span class="kr">string</span> <span class="o">=</span> <span class="s1">'http://localhost:3000'</span><span class="p">;</span>

  <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">}</span><span class="sr">/items`</span><span class="err">;
</span>    <span class="k">this</span><span class="p">.</span><span class="nx">http</span>
      <span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jsonToList</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">todo</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="http-fetching-data-2" -->
<h2 id="fetch-data-from-the-server-1">Fetch Data From the Server</h2>

<ol>
  <li>In real applications, <code class="highlighter-rouge">baseUrl</code> will be a configuration parameter.</li>
  <li>Define <code class="highlighter-rouge">url</code> to point to the top-level key in the “database”.</li>
  <li>Use the <code class="highlighter-rouge">http</code> service to GET that URL…</li>
  <li>…then use <code class="highlighter-rouge">map</code> to extract the JSON body from the result…
    <ul>
      <li>This is <code class="highlighter-rouge">Observable.map</code> on one item, not <code class="highlighter-rouge">Array.map</code> on many</li>
    </ul>
  </li>
  <li>…then use <code class="highlighter-rouge">subscribe</code> to handle the (single) notification from the observable
    <ul>
      <li>If all goes well, extract the text of the to-do list items with <code class="highlighter-rouge">jsonToList</code></li>
      <li>If there’s an error, report it</li>
    </ul>
  </li>
</ol>

<!-- comment needed to separate lists -->
<ul>
  <li>Note: JSON Server requires us to:
    <ol>
      <li>Store data below top-level keys (hence <code class="highlighter-rouge">items</code> <em>and</em> <code class="highlighter-rouge">todo</code>)</li>
      <li>Store lists as objects with an <code class="highlighter-rouge">id</code> field</li>
    </ol>
  </li>
  <li>Which is why we need <code class="highlighter-rouge">jsonToList</code></li>
</ul>

<hr />
<!-- .slide: id="http-sending-data" -->
<h2 id="send-data-to-server">Send Data to Server</h2>

<p><em>src/app/to-do.service.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code>  <span class="nx">addItem</span><span class="p">(</span><span class="nx">item</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">changes</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="p">}</span><span class="sr">/items`</span><span class="err">;
</span>    <span class="k">this</span><span class="p">.</span><span class="nx">http</span>
      <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span><span class="na">todo</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">listToJson</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">items</span><span class="p">)})</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">);</span>
  <span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>Note structure of data sent to server (required by JSON Server)</li>
  <li>Only handle error returns in <code class="highlighter-rouge">subscribe</code></li>
</ul>


          <hr/>
          <a href="http://localhost:4000/">Home</a>
        </div>
      </div>
    </div>
  </body>
</html>
