<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="search-domain" content="http://rangle.io" />
    <link href="http://localhost:4000/css/bootstrap.css" rel="stylesheet" />
    <link href="http://localhost:4000/css/bootstrap-theme.css" rel="stylesheet" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Unit Testing</title>
  </head>
  <body>
    <div class="container shadow">
      <div class="row-fluid">
        <div class="span10 offset1">
          <p><a href="http://rangle.io">Rangle.io</a> Angular Training</a></p>
          <h1>Unit Testing</h1>
          <hr />
<!-- .slide: id="unit-testing-roadmap" -->

<h2 id="roadmap">Roadmap</h2>

<ol>
  <li>What tools should I use to test Angular applications?</li>
  <li>Where should I put my tests?</li>
  <li>How can I write and run simple tests?</li>
  <li>How do I test a pipe?</li>
  <li>How do I create an isolated unit test for a component or service?</li>
  <li>How can I create mock objects for dependencies?</li>
  <li>When do I use TestBed and how do I configure it?</li>
  <li>What testing utilities do I use with TestBed?</li>
  <li>How do I do shallow rendering to test a component?</li>
  <li>How can I query native HTML elements?</li>
  <li>How do I run change detection during my test?</li>
  <li>How do I deal with asynchronous functions in my tests?</li>
  <li>How I test a service that depends on Http?</li>
  <li>How do I use a spy to mock a method and check that the correct parameters are passed?</li>
</ol>

<hr />
<!-- .slide: id="unit-testing-toolchain" -->
<h2 id="toolchain">Toolchain</h2>

<ul>
  <li><a href="https://jasmine.github.io/">Jasmine</a>: behavior-driven testing framework</li>
  <li><a href="https://karma-runner.github.io/1.0/index.html">Karma</a>: test runner</li>
  <li><a href="https://gotwarlost.github.io/istanbul/">Istanbul</a>: coverage report generator</li>
  <li><a href="https://github.com/mlex/karma-spec-reporter">karma-spec-reporter</a>: provides clean reports in terminal
    <ul>
      <li>install with <code class="highlighter-rouge">npm install karma-spec-reporter --save-dev</code></li>
      <li>in <code class="highlighter-rouge">karma.config</code> change reporters: <code class="highlighter-rouge">reporters: ['spec']</code></li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="unit-testing-running-tests" -->
<h2 id="running-tests">Running Tests</h2>

<ul>
  <li><code class="highlighter-rouge">ng test</code> or <code class="highlighter-rouge">yarn test</code>: launches a browser for testing and watches for changes
    <ul>
      <li>Compiles and re-runs tests as files change</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">ng test --code-coverage</code>: puts a coverage report in <code class="highlighter-rouge">coverage/</code> directory</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-creating-test-files" -->
<h2 id="creating-test-files">Creating Test Files</h2>

<ul>
  <li>Angular CLI automatically creates test files for components</li>
  <li>Adds <code class="highlighter-rouge">.spec</code> to test file names so Jasmine and the build system recognize them as tests</li>
  <li>E.g., <code class="highlighter-rouge">src/app/app.component.spec.ts</code> does basic tests of <code class="highlighter-rouge">AppComponent</code></li>
</ul>

<hr />
<!-- .slide: id="unit-testing-arrange-act-assert" -->
<h2 id="arrange-act-and-assert-with-jasmine">Arrange, Act and Assert with Jasmine</h2>

<p>Note the following in the generated tests:</p>

<ul>
  <li><code class="highlighter-rouge">describe</code> explains what the test is</li>
  <li><code class="highlighter-rouge">beforeEach</code> runs code before each test</li>
  <li><code class="highlighter-rouge">it</code> explains the result we are expecting</li>
  <li><code class="highlighter-rouge">expect</code> formulates a scenario</li>
  <li><code class="highlighter-rouge">toBeTruthy</code> is a matcher that asserts the expected outcome</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-testing-a-pipe" -->
<h2 id="testing-a-pipe">Testing a Pipe</h2>

<ul>
  <li><code class="highlighter-rouge">ng generate pipe capitalize</code></li>
</ul>

<p>#####<em>src/app/capitalize.pipe.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Pipe</span><span class="p">,</span> <span class="nx">PipeTransform</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="err">@</span><span class="nx">Pipe</span><span class="p">({</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'capitalize'</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">CapitalizePipe</span> <span class="k">implements</span> <span class="nx">PipeTransform</span> <span class="p">{</span>
  <span class="nx">transform</span><span class="p">(</span><span class="nx">inputText</span><span class="err">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">args</span><span class="p">?:</span> <span class="kr">any</span><span class="p">)</span><span class="err">:</span> <span class="kr">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">inputText</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-starter-code" -->
<h2 id="starter-code-for-testing">Starter Code for Testing</h2>

<p>#####<em>src/app/capitalize.pipe.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">CapitalizePipe</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./capitalize.pipe'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'CapitalizePipe'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'create an instance'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">pipe</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CapitalizePipe</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">pipe</span><span class="p">).</span><span class="nx">toBeTruthy</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-instantiate-pipe" -->
<h2 id="instantiate-the-pipe-in-beforeeach">Instantiate the Pipe in <code class="highlighter-rouge">beforeEach</code></h2>

<ul>
  <li>We will need an instance for each test, so instantiate it in the <code class="highlighter-rouge">beforeEach</code> to avoid duplicating code</li>
</ul>

<p>#####<em>src/app/capitalize.pipe.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'CapitalizePipe'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">pipe</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">pipe</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CapitalizePipe</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="c1">// ...instance creation test as before...</span>

<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>Have to declare <code class="highlighter-rouge">pipe</code> outside <code class="highlighter-rouge">beforeEach</code> so that it will be visible in test functions</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-add-a-test" -->
<h2 id="add-a-test">Add a Test</h2>

<ul>
  <li>We several broken tests that we’ll simply ignore for now
    <ul>
      <li>Use <code class="highlighter-rouge">fdescribe</code> to tell Jasmine to “<strong>f</strong>ocus” on this test so we don’t see the other failing tests</li>
    </ul>
  </li>
  <li>Here we use the <code class="highlighter-rouge">toEqual</code> Jasmine matcher which performs a deep equality check
    <ul>
      <li>The <code class="highlighter-rouge">toBe</code> matcher, which performs a strict equality check (<code class="highlighter-rouge">===</code>), would also work here</li>
    </ul>
  </li>
</ul>

<p>#####<em>src/app/capitalize.pipe.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">fdescribe</span><span class="p">(</span><span class="s1">'CapitalizePipe'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="c1">// ...as before...</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should capitalize a word'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">pipe</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">)).</span><span class="nx">toEqual</span><span class="p">(</span><span class="s1">'Foo'</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-instantiating-component--or-service" -->
<h2 id="instantiating-the-component-or-service">Instantiating the Component or Service</h2>

<ul>
  <li>We currently do not display the number of todos in <code class="highlighter-rouge">AppComponent</code></li>
  <li>Let’s create a method that will return the number of todos</li>
  <li>Start by removing existing test code until we have the shell of a simple test for this component</li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">AppComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'./app.component'</span><span class="p">;</span>

<span class="nx">fdescribe</span><span class="p">(</span><span class="s1">'AppComponent'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should count the number of items'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-mocking-dependencies" -->
<h2 id="mocking-dependencies">Mocking Dependencies</h2>

<ul>
  <li>We need an object that matches the “shape” of <code class="highlighter-rouge">TodoService</code> to test <code class="highlighter-rouge">AppComponent</code></li>
  <li>Note the use of <code class="highlighter-rouge">as</code> to assert the type of our mock</li>
  <li>The mock object must have an <code class="highlighter-rouge">addItem</code> method and <code class="highlighter-rouge">items</code> property</li>
  <li><code class="highlighter-rouge">addItem</code> doesn’t actually need to do anything</li>
  <li><code class="highlighter-rouge">items</code> should be an array of fake todos</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">mockToDoService</span><span class="err">:</span> <span class="nx">ToDoService</span><span class="p">;</span>

<span class="nx">mockToDoService</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">addItem</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">items</span><span class="p">:</span> <span class="p">[</span><span class="s1">'item 1'</span><span class="p">,</span> <span class="s1">'item 2'</span><span class="p">,</span> <span class="s1">'item 3'</span><span class="p">]</span>
<span class="p">}</span> <span class="k">as</span> <span class="nx">ToDoService</span><span class="p">;</span>
</code></pre>
</div>

<ul>
  <li>We can manually provide this to <code class="highlighter-rouge">AppComponent</code> by passing it to the constructor</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-testing-business-logic" -->
<h2 id="testing-business-logic">Testing Business Logic</h2>

<ul>
  <li>Here we write a failing test</li>
  <li>Next, we’ll create the method in <code class="highlighter-rouge">AppComponent</code> that will make this test pass</li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code>  <span class="nx">describe</span><span class="p">(</span><span class="s1">'the itemCount method'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="kd">let</span> <span class="na">comp</span><span class="p">:</span> <span class="nx">AppComponent</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">mockToDoService</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">mockToDoService</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">addItem</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{},</span>
        <span class="na">items</span><span class="p">:</span> <span class="p">[</span><span class="s1">'item 1'</span><span class="p">,</span> <span class="s1">'item 2'</span><span class="p">,</span> <span class="s1">'item 3'</span><span class="p">]</span>
      <span class="p">};</span>
      <span class="nx">comp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AppComponent</span><span class="p">(</span><span class="nx">mockToDoService</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">'should return the number of items'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">expect</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">itemCount</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-when-to-use-testbed" -->
<h2 id="when-to-use-testbed">When to Use TestBed</h2>

<ul>
  <li><code class="highlighter-rouge">TestBed</code> is a class that creates a real Angular runtime for the purposes of testing Angular elements</li>
  <li>It is helpful when:
    <ol>
      <li>you have logic in your templates and you want to render a component class along with its template for testing</li>
      <li>you want to use Angular’s injector to handle dependency injection for you</li>
      <li>you want to test how different elements integrate in the Angular runtime</li>
    </ol>
  </li>
</ul>

<!-- comment needed to separate lists -->

<ul>
  <li>We do not instantiate the class we want to test when using <code class="highlighter-rouge">TestBed</code>
    <ul>
      <li>We let Angular do that for us</li>
    </ul>
  </li>
  <li>Using the test fixture, Angular will give us the instance it created</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-configure-the-test-module" -->
<h2 id="configuring-the-test-module">Configuring the Test Module</h2>

<ul>
  <li>We can declare <code class="highlighter-rouge">mockToDoService</code> as we did before and have Angular inject it for us</li>
  <li>TestBed will also instantiate the <code class="highlighter-rouge">AppComponent</code> and inject the dependency for us
    <ul>
      <li>But we must add it to the <code class="highlighter-rouge">declarations</code> array</li>
    </ul>
  </li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span> <span class="nx">AppComponent</span> <span class="p">],</span>
  <span class="na">providers</span><span class="p">:[</span>
    <span class="p">{</span> <span class="na">provide</span><span class="p">:</span> <span class="nx">ToDoService</span><span class="p">,</span> <span class="na">useValue</span><span class="p">:</span> <span class="nx">mockToDoService</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">})</span>
</code></pre>
</div>

<hr />

<!-- .slide: id="unit-testing-testing-components-using-componentfixture" -->
<h2 id="testing-components-using-componentfixture">Testing Components Using ComponentFixture</h2>

<ul>
  <li><code class="highlighter-rouge">ComponentFixture</code> is a testing utility that gives us access and control over the things we are testing</li>
  <li>The <code class="highlighter-rouge">componentInstance</code> property of the fixture is an instance of <code class="highlighter-rouge">AppComponent</code>.
    <ul>
      <li>Here, we assign to to the <code class="highlighter-rouge">comp</code> variable to be used later in our tests</li>
    </ul>
  </li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">fixture</span><span class="err">:</span> <span class="nx">ComponentFixture</span><span class="o">&lt;</span><span class="nx">AppComponent</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">comp</span><span class="err">:</span> <span class="nx">AppComponent</span><span class="p">;</span>

<span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
    <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span> <span class="nx">AppComponent</span> <span class="p">],</span>
    <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="na">provide</span><span class="p">:</span> <span class="nx">ToDoService</span><span class="p">,</span> <span class="na">useValue</span><span class="p">:</span> <span class="nx">mockToDoService</span> <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">});</span>

  <span class="nx">fixture</span> <span class="o">=</span> <span class="nx">TestBed</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">(</span><span class="nx">AppComponent</span><span class="p">);</span>
  <span class="nx">comp</span> <span class="o">=</span> <span class="nx">fixture</span><span class="p">.</span><span class="nx">componentInstance</span><span class="p">;</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<!-- .slide: id="unit-testing-shallow-rendering" -->
<h2 id="shallow-rendering">Shallow Rendering</h2>

<ul>
  <li>The above test fails because <code class="highlighter-rouge">AppComponent</code> uses components which we have not declared</li>
  <li>We could provide mocks for these components, or do a shallow render by adding the <code class="highlighter-rouge">CUSTOM_ELEMENTS_SCHEMA</code></li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
  <span class="na">schemas</span><span class="p">:</span> <span class="p">[</span> <span class="nx">CUSTOM_ELEMENTS_SCHEMA</span> <span class="p">]</span>
<span class="p">})</span>
</code></pre>
</div>

<p>Notes:</p>

<ul>
  <li><code class="highlighter-rouge">NO_ERRORS_SCHEMA</code> is also commonly used for shallow rendering</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-providing-the-real-service" -->
<h2 id="providing-the-real-service">Providing the Real Service</h2>

<ul>
  <li>Alternatively, we can have Angular create the real service</li>
  <li>We can then use <code class="highlighter-rouge">TestBed</code> to get a reference to the injected instance and set some state</li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span> <span class="nx">AppComponent</span> <span class="p">],</span>
  <span class="na">schemas</span><span class="p">:</span> <span class="p">[</span> <span class="nx">CUSTOM_ELEMENTS_SCHEMA</span> <span class="p">],</span>
  <span class="na">providers</span><span class="p">:[</span> <span class="nx">ToDoService</span> <span class="p">]</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">toDoService</span> <span class="o">=</span> <span class="nx">TestBed</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">ToDoService</span><span class="p">);</span>
<span class="nx">toDoService</span><span class="p">.</span><span class="nx">items</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'item 1'</span><span class="p">,</span> <span class="s1">'item 2'</span><span class="p">,</span> <span class="s1">'item 3'</span><span class="p">];</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-importing-the-real-module" -->
<h2 id="importing-the-real-module">Importing the Real Module</h2>

<ul>
  <li>We can import the real module that declares the component and provides the service it depends on</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
  <span class="na">imports</span><span class="p">:</span> <span class="p">[</span> <span class="nx">AppModule</span> <span class="p">]</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-querying-native-elements" -->
<h2 id="integration-testing-by-querying-native-elements">Integration Testing by Querying Native Elements</h2>

<ul>
  <li>Importing the <code class="highlighter-rouge">AppModule</code>, override the <code class="highlighter-rouge">ToDoService</code> by providing the mock as before</li>
  <li>We can use the <code class="highlighter-rouge">debugElement</code> to query the generated DOM</li>
  <li>The test fails because we changed the data in the service after the component was created and the view hasn’t detected it</li>
</ul>

<p>#####<em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'AppComponent'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">comp</span><span class="p">:</span> <span class="nx">AppComponent</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">fixture</span><span class="p">:</span> <span class="nx">ComponentFixture</span><span class="o">&lt;</span><span class="nx">AppComponent</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// TestBed.configureModule({ ...</span>
    <span class="nx">fixture</span> <span class="o">=</span> <span class="nx">TestBed</span><span class="p">.</span><span class="nx">createComponent</span><span class="p">(</span><span class="nx">AppComponent</span><span class="p">);</span>
    <span class="nx">comp</span> <span class="o">=</span> <span class="nx">fixture</span><span class="p">.</span><span class="nx">componentInstance</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'should show all todo items'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">fixture</span><span class="p">.</span><span class="nx">debugElement</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">By</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">'ul'</span><span class="p">));</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-change-detection" -->
<h2 id="change-detection">Change Detection</h2>

<ul>
  <li>We must tell Angular when to run change detection during our tests</li>
  <li>The <code class="highlighter-rouge">ComponentFixture.detectChanges</code> method makes this possible</li>
  <li>Our test should now pass</li>
</ul>

<p><em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should show all todo items'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> 
<span class="nx">fixture</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
<span class="c1">// ...</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-automatic-change-detection" -->
<h2 id="automatic-change-detection">Automatic Change Detection</h2>

<ul>
  <li>We can indicate that we want <em>automatic change detection</em> when configuring our test module</li>
</ul>

<p><em>src/app/app.component.spec.ts</em></p>
<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">TestBed</span><span class="p">.</span><span class="nx">configureTestingModule</span><span class="p">({</span>
  <span class="na">declarations</span><span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="na">provide</span><span class="p">:</span> <span class="nx">ComponentFixtureAutoDetect</span><span class="p">,</span> <span class="na">useValue</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<!-- .slide: id="unit-testing-dealing-with-async" -->
<h2 id="dealing-with-asynchronous-behavior-in-tests">Dealing With Asynchronous Behavior in Tests</h2>

<ul>
  <li>Angular tests generated by the CLI use the asynchronous function <code class="highlighter-rouge">compileComponents</code> and wrap it in the <code class="highlighter-rouge">async</code> function</li>
  <li><code class="highlighter-rouge">compileComponents</code> is required for testing when classes reference external files through <code class="highlighter-rouge">templateUrls</code> and <code class="highlighter-rouge">styleUrls</code></li>
  <li>We usually don’t need to do this
    <ul>
      <li>Webpack will inline our templates and css as part of the build process</li>
      <li>But we will often need to use <code class="highlighter-rouge">async</code> and a similar function <code class="highlighter-rouge">fakeAsync</code> in our tests</li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="unit-testing-running-tests-in-a-zone" -->
<h2 id="running-tests-in-a-zone">Running Tests in a Zone</h2>

<ul>
  <li>Jasmine can run asynchronous tests like this:</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should...'</span><span class="p">,</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">myComponent</span><span class="p">.</span><span class="nx">getData</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span><span class="na">abc</span><span class="p">:</span> <span class="mi">123</span><span class="p">});</span>
    <span class="nx">done</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<ul>
  <li>Without <code class="highlighter-rouge">done</code> the test finishes before the callback is run</li>
  <li>Angular’s solution is to run all of our test code inside a <a href="https://github.com/angular/zone.js">Zone.js</a> zone
where it can track all asynchronous activity and wait for all tasks to complete</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-zone-js" -->
<h2 id="interlude-zonejs">Interlude: Zone.js</h2>

<ul>
  <li>Zones allow Angular to create execution contexts that track the completion of asynchronous operations</li>
  <li><a href="https://github.com/angular/zone.js">Zone.js</a> accomplishes this by monkey patching many common asynchronous methods</li>
  <li>Zones are used in Angular applications to let Angular know when change detection should run
    <ul>
      <li>Since change detection is often required after asynchronous operations complete</li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="unit-testing-using-async" -->
<h2 id="using-async">Using <code class="highlighter-rouge">async</code></h2>

<ul>
  <li>The <code class="highlighter-rouge">async</code> function can be used to test asynchronous functions</li>
  <li>The same test could be written as:</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should...'</span><span class="p">,</span> <span class="k">async</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">myComponent</span><span class="p">.</span><span class="nx">getData</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span><span class="na">abc</span><span class="p">:</span> <span class="mi">123</span><span class="p">});</span>
  <span class="p">});</span>
<span class="p">}));</span>
</code></pre>
</div>

<ul>
  <li>Angular will now wait for the <code class="highlighter-rouge">expect</code> function to complete</li>
</ul>

<hr />
<!-- .slide: id="unit-testing-using-fakeasync" -->
<h2 id="using-fakeasync">Using <code class="highlighter-rouge">fakeAsync</code></h2>

<ul>
  <li>This test tests debouncing <em>without</em> actually waiting for hundreds of milliseconds
    <ul>
      <li>Assumes <code class="highlighter-rouge">comp</code> has been assigned a component to test</li>
    </ul>
  </li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should debounce change to search query for 300 ms'</span><span class="p">,</span> <span class="nx">fakeAsync</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">spyOn</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">queryChanged</span><span class="p">,</span> <span class="s1">'emit'</span><span class="p">);</span>
  <span class="nx">comp</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span><span class="s1">'abc'</span><span class="p">);</span>
  <span class="nx">tick</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">queryChanged</span><span class="p">.</span><span class="nx">emit</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
  <span class="nx">tick</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">comp</span><span class="p">.</span><span class="nx">queryChanged</span><span class="p">.</span><span class="nx">emit</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="s1">'abc'</span><span class="p">);</span>
<span class="p">}));</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-testing-services" -->
<h2 id="testing-services">Testing Services</h2>

<ul>
  <li>Test services in Angular using many of the same techniques and strategies used for testing components</li>
  <li>Main emphasis in testing services is data
    <ul>
      <li>Are we <em>getting</em>, <em>storing</em>, and <em>propagating</em> data correctly?</li>
    </ul>
  </li>
  <li>Services will typically make HTTP requests, so we will want to:
    <ul>
      <li>Verify the contents of the request being made (correct URL)</li>
      <li>Ensure that the data we mock is returned by the right method</li>
      <li>Ensure that data is being returned in the correct format</li>
    </ul>
  </li>
</ul>

<hr />
<!-- .slide: id="unit-testing-testing-http" -->
<h2 id="todoservice-with-http">ToDoService with HTTP</h2>

<ul>
  <li>Suppose we want to test a version of <code class="highlighter-rouge">ToDoService</code> that uses <code class="highlighter-rouge">Http</code></li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kr">class</span> <span class="nx">ToDoService</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">todoList</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="nx">getProducts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'http://localhost:3000/todos'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">todo</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">getTodoTaskForDisplay</span><span class="p">(</span><span class="nx">todo</span><span class="p">.</span><span class="nx">label</span><span class="p">,</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">id</span><span class="p">)))</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">todos</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">todoList</span> <span class="o">=</span> <span class="nx">todos</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">getTodoTaskForDisplay</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">isComplete</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">id</span><span class="p">,</span>
      <span class="nx">label</span><span class="p">,</span>
      <span class="nx">isComplete</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-light-http-mock" -->
<h2 id="providing-a-light-http-mock">Providing a Light HTTP Mock</h2>

<ul>
  <li>A light mock can be used in place of the actual Http service</li>
  <li>Note the use of <code class="highlighter-rouge">as</code> to assert the type of our mock</li>
  <li>A Jasmine spy provides the mock implementation of the get method</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="s1">'toDoService'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="na">toDoService</span><span class="p">:</span> <span class="nx">ToDoService</span><span class="p">;</span>
  <span class="kd">let</span> <span class="na">mockHttp</span><span class="p">:</span> <span class="nx">Http</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">mockHttp</span> <span class="o">=</span> <span class="p">{</span> <span class="na">get</span><span class="p">:</span> <span class="kc">null</span> <span class="p">}</span> <span class="k">as</span> <span class="nx">Http</span><span class="p">;</span>
    <span class="nx">spyOn</span><span class="p">(</span><span class="nx">mockHttp</span><span class="p">,</span> <span class="s1">'get'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">returnValue</span><span class="p">(</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">of</span><span class="p">({</span>
      <span class="na">json</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">label</span><span class="p">:</span> <span class="s1">'first'</span><span class="p">,</span> <span class="na">done</span><span class="p">:</span> <span class="kc">false</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">label</span><span class="p">:</span> <span class="s1">'second'</span><span class="p">,</span> <span class="na">done</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}));</span>
    <span class="nx">toDoService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ToDoService</span><span class="p">(</span><span class="nx">mockHttp</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-asserting-method" -->
<h2 id="assert-that-the-method-retrieves-data">Assert that the Method Retrieves Data</h2>

<ul>
  <li>The following test checks that the <code class="highlighter-rouge">getData</code> method assigns the correct data in the correct format to the <code class="highlighter-rouge">toDoList</code> property</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code>  <span class="nx">it</span><span class="p">(</span><span class="s1">'should return data in correct format'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="nx">toDoService</span><span class="p">.</span><span class="nx">getProducts</span><span class="p">();</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">toDoService</span><span class="p">.</span><span class="nx">todoList</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([</span>
      <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">label</span><span class="p">:</span> <span class="s1">'first'</span><span class="p">,</span> <span class="na">isComplete</span><span class="p">:</span> <span class="kc">false</span> <span class="p">},</span>
      <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">label</span><span class="p">:</span> <span class="s1">'second'</span><span class="p">,</span> <span class="na">isComplete</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
    <span class="p">]);</span>

  <span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="unit-testing-spying-to-check-url" -->
<h2 id="using-the-spy-to-check-the-url">Using the Spy to Check the URL</h2>

<ul>
  <li>The following test checks that the correct URL is being used</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'should be called with http://localhost:3000/todos'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">toDoService</span><span class="p">.</span><span class="nx">getProducts</span><span class="p">();</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">mockHttp</span><span class="p">.</span><span class="nx">get</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="s1">'http://localhost:3000/todos'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

          <hr/>
          <a href="http://localhost:4000/">Home</a>
        </div>
      </div>
    </div>
  </body>
</html>
