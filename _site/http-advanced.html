<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="search-domain" content="http://rangle.io" />
    <link href="http://localhost:4000/css/bootstrap.css" rel="stylesheet" />
    <link href="http://localhost:4000/css/bootstrap-theme.css" rel="stylesheet" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Advanced HTTP</title>
  </head>
  <body>
    <div class="container shadow">
      <div class="row-fluid">
        <div class="span10 offset1">
          <p><a href="http://rangle.io">Rangle.io</a> Angular Training</a></p>
          <h1>Advanced HTTP</h1>
          <hr />
<!-- .slide: id="http-advanced-roadmap" -->
<h2 id="roadmap">Roadmap</h2>

<p>FIXME: this module needs to be updated and proof-read</p>

<hr />
<!-- .slide: id="http-advanced-catch-operator" -->
<h2 id="using-the-catch-operator">Using the <code class="highlighter-rouge">.catch</code> operator</h2>

<ul>
  <li>Using <code class="highlighter-rouge">.catch</code> we can inspect an error and decide how to handle it</li>
  <li>By not calling <code class="highlighter-rouge">subscribe</code> our code is more declarative</li>
  <li>Can take advantage of the <code class="highlighter-rouge">async</code> pipe in your template</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code>  <span class="nx">search</span><span class="p">(</span><span class="nx">term</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="err">`</span><span class="nx">https</span><span class="err">:</span><span class="c1">//api.spotify.com/v1/dsds?q=${term}&amp;type=artist`)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;==</span>  <span class="mi">500</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cachedVersion</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span>
          <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">status</span> <span class="p">}</span> <span class="nx">$</span><span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">statusText</span> <span class="p">}</span><span class="err">`</span><span class="p">)</span>
        <span class="p">);</span>
      <span class="p">}</span>
  <span class="p">});</span>
</code></pre>
</div>

<hr />
<!-- .slide: id="http-advanced-cancel-request" -->
<h2 id="cancel-a-request">Cancel a Request</h2>

<ul>
  <li>One of the greatest benefits to using observables over promises is the ability to cancel <code class="highlighter-rouge">http</code> requests</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code>  <span class="nx">search</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchService</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">searchField</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
        <span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">artists</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span> <span class="p">},</span>
        <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span> <span class="p">},</span>
        <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Completed'</span><span class="p">);</span> <span class="p">}</span>
      <span class="p">);</span>

    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">request</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">()},</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// cancel request after 0 milliseconds</span>
  <span class="p">}</span>
</code></pre>
</div>
<p><a href="http://plnkr.co/edit/MByeTy?p=preview">View Example</a></p>

<hr />
<!-- .slide: id="http-advanced-cancel-request-with-takeuntil" -->
<h2 id="cancel-a-request-with-takeuntil">Cancel a Request with <code class="highlighter-rouge">takeUntil</code></h2>

<ul>
  <li>Managing subscription cancellation via <code class="highlighter-rouge">unsubscribe</code> can get messy</li>
  <li>The <code class="highlighter-rouge">takeUntil</code> operator allows us to compose your subscription management</li>
  <li><code class="highlighter-rouge">takeUntil</code> emits items from an observable until a given observable emits an item</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code><span class="nx">search</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchService</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">searchField</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">takeUntil</span><span class="p">(</span><span class="nx">someOtherStream</span><span class="p">)</span> <span class="c1">// take until someOtherStream emits an item</span>
    <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span>
      <span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">artists</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span> <span class="p">},</span>
      <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">errorMessage</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span> <span class="p">},</span>
      <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">cancelMessage</span> <span class="o">=</span> <span class="s1">'Your request has been cancelled'</span> <span class="p">}</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li><strong>NOTE:</strong> <code class="highlighter-rouge">takeUntil</code> will complete the observable unlike <code class="highlighter-rouge">unsubscribe</code></li>
</ul>

<p><a href="https://plnkr.co/edit/v2aGkTCmi34jBr7an1i8?p=preview">View Example</a></p>

<hr />
<!-- .slide: id="http-advanced-retry-request" -->
<h2 id="retry-a-request">Retry a request</h2>

<ul>
  <li>Retry a failed request with the <code class="highlighter-rouge">retry</code> operator</li>
  <li>Useful for when a userâ€™s connection is lost</li>
  <li><code class="highlighter-rouge">retry</code> takes an argument to specify the number of retries</li>
  <li>if no argument is given, the request will be retried indefinitely</li>
</ul>

<div class="language-ts highlighter-rouge"><pre class="highlight"><code>  <span class="nx">search</span><span class="p">(</span><span class="nx">term</span><span class="err">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">tryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'https://api.spotify.com/v1/dsds?q='</span> <span class="o">+</span> <span class="nx">term</span> <span class="o">+</span> <span class="s1">'&amp;type=artist'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
      <span class="p">.</span><span class="nx">retry</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>  <span class="c1">// Will retry failed request 3 times</span>
<span class="p">}</span>
</code></pre>
</div>
<ul>
  <li><strong>Note:</strong> The <code class="highlighter-rouge">onError</code> callback will not execute during the retry phase. The stream will only throw an error after the retry phase is complete</li>
</ul>

<p><a href="http://plnkr.co/edit/zSAWwV?p=preview">View Example</a></p>

          <hr/>
          <a href="http://localhost:4000/">Home</a>
        </div>
      </div>
    </div>
  </body>
</html>
